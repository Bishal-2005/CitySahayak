<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ 'Edit Incident' if incident else 'Report Incident' }}</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* Background */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Glassmorphism Form Container */
    .form-container {
      max-width: 700px;
      margin: 40px auto;
      padding: 25px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(12px);
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
      color: white;
      animation: fadeIn 1s ease-in-out;
    }

    .form-label {
      font-weight: 600;
    }

    .form-control, .form-select {
      border-radius: 10px;
      border: none;
      padding: 10px 12px;
    }

    .form-control:focus, .form-select:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.4);
    }

    .preview {
      margin-top: 10px;
      max-width: 100%;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    video, canvas {
      width: 100%;
      border-radius: 10px;
      margin-top: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    h2 {
      color: #fff;
      font-weight: 700;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    }

    /* Fade-in animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  {% include "navbar.html" %}

  <div class="container">
    <div class="form-container">
      <h2 class="text-center mb-4">{{ 'Edit Incident' if incident else 'Report Incident' }}</h2>

      <form method="POST" enctype="multipart/form-data" class="row g-3">
        <!-- Title -->
        <div class="col-12">
          <label for="title" class="form-label">Incident Title</label>
          <input type="text" id="title" name="title" class="form-control"
                 value="{{ incident.title if incident else '' }}"
                 placeholder="Enter incident title" required>
        </div>

        <!-- Description -->
        <div class="col-12">
          <label for="description" class="form-label">Description</label>
          <textarea id="description" name="description" rows="4" 
                    class="form-control"
                    placeholder="Describe the incident" required>{{ incident.description if incident else '' }}</textarea>
        </div>

        <!-- Location -->
        <div class="col-md-6 col-12">
          <label for="location" class="form-label">Location</label>
          <input type="text" id="location" name="location" class="form-control"
                 value="{{ incident.location if incident else '' }}"
                 placeholder="Enter location" required>
        </div>

        <!-- Category Dropdown -->
        <div class="col-md-6 col-12">
          <label for="category" class="form-label">Category</label>
          <select id="category" name="category" class="form-select" required>
            <option value="">-- Select Category --</option>
            <option value="Fire" {{ 'selected' if incident and incident.category=='Fire' }}>ðŸ”¥ Fire</option>
            <option value="Accident" {{ 'selected' if incident and incident.category=='Accident' }}>ðŸš— Accident</option>
            <option value="Crime" {{ 'selected' if incident and incident.category=='Crime' }}>ðŸš¨ Crime</option>
            <option value="Flood" {{ 'selected' if incident and incident.category=='Flood' }}>ðŸŒŠ Flood</option>
            <option value="Other" {{ 'selected' if incident and incident.category=='Other' }}>ðŸ“Œ Other</option>
          </select>
        </div>

        <!-- Image Upload -->
        <div class="col-12">
          <label for="image" class="form-label">Upload Image</label>
          {% if incident and incident.image_filename %}
            <p>Current Image:</p>
            <img src="{{ url_for('static', filename='uploads/' ~ incident.image_filename) }}" class="preview img-fluid">
          {% endif %}
          <input type="file" id="image" name="image" class="form-control" accept="image/*">
          <img id="preview" class="preview" style="display:none;">
        </div>

        <!-- Camera Buttons -->
        <div class="col-12 d-flex gap-2">
          <button type="button" class="btn btn-primary flex-fill" onclick="openCamera()">ðŸ“· Open Camera</button>
          <button type="button" class="btn btn-success flex-fill" onclick="capturePhoto()">ðŸ“¸ Capture Photo</button>
        </div>

        <!-- Camera + Canvas -->
        <div class="col-12">
          <video id="camera" autoplay style="display:none;"></video>
          <canvas id="canvas" style="display:none;"></canvas>
        </div>

        <!-- Submit -->
        <div class="col-12">
          <button type="submit" class="btn btn-lg btn-success w-100">
            {{ 'Update Incident' if incident else 'Submit Report' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const fileInput = document.getElementById("image");
    const preview = document.getElementById("preview");

    if (fileInput) {
      fileInput.addEventListener("change", function(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            preview.src = e.target.result;
            preview.style.display = "block";
          }
          reader.readAsDataURL(file);
        }
      });
    }

    let cameraStream;
    function openCamera() {
      const camera = document.getElementById("camera");
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          camera.srcObject = stream;
          camera.style.display = "block";
          cameraStream = stream;
        })
        .catch(err => alert("Camera not accessible: " + err));
    }

    function capturePhoto() {
      const camera = document.getElementById("camera");
      const canvas = document.getElementById("canvas");
      const context = canvas.getContext("2d");
      canvas.width = camera.videoWidth;
      canvas.height = camera.videoHeight;
      context.drawImage(camera, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(blob => {
        const file = new File([blob], "captured.png", { type: "image/png" });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;
        preview.src = URL.createObjectURL(file);
        preview.style.display = "block";
      });
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }
      camera.style.display = "none";
    }
  </script>
</body>
</html>
